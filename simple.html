<!DOCTYPE html>
<html>
  <head>
    <title>Briefcase!!</title>
    <style rel="stylesheet" type="text/css">
      html, body {
        position: fixed;
        left: 0; top: 0;
        width: 100%; height: 100%;
        margin: 0; padding: 0;
        background-color: #a8a8a8;
        font-family: sans-serif;
      }
      .snackControl {
        position: absolute;
        width: 400px; height: 400px;
        left: 50%; top: 50%;
        margin-left: -200px; margin-top: -200px;
        box-shadow: 0 0 0 10px #000000;
        background-color: #ffffff;
        user-select: none;
      }
      .snackControl > .loading {
        position: absolute;
        left: 0; top: 0;
        width: 400px; height: 400px; line-height: 400px;
        font-size: 24px;
        text-align: center;
        background-color: #ffffff;
      }
      .snackControl > .available, .snackControl > .inserted {
        position: absolute;
      }
      .snackControl > .available {
        width: 50%; height: 100%;
        left: 0;
      }
      .snackControl > .inserted {
        width: 50%; height: 100%;
        right: 0;
      }
      .snack {
        position: relative;
        background-color: rgba(0, 0, 0, 0.3);
        width: 100%; height: 30px; line-height: 30px;
        text-align: center;
        box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.4);
        overflow: hidden;
        white-space: nowrap;
      }
      .snack > .text {
        position: absolute;
        width: 100%; height: 30px; line-height: 30px;
        color: #ffffff;
        z-index: 2;
      }
      .snack:before {
        content: ''; display: block; position: absolute;
        width: 300px; height: 300px;
        left: -120px; top: 145px;
        margin-left: -250px; margin-top: -250px;
        transform: rotate(45deg);
        background-color: #000000;
        box-shadow: 0 0 20px 2px #000000;
        transition: left 300ms ease-in-out;
        z-index: 1;
      }
      .snack:hover:before { left: 150px; }
      .available > .snack:before { background-color: #00a010; box-shadow: 0 0 20px 2px #00a010; }
      .inserted > .snack:before { background-color: #c00000; box-shadow: 0 0 20px 2px #c00000; }
    </style>
    <script type="text/javascript">(async () => {
      let poll = async (cmd, params=null) => {
        let req = new XMLHttpRequest();
        req.open('GET', cmd, true);
        req.setRequestHeader('Content-Type', 'application/json');
        req.send(JSON.stringify(params));
        
        return new Promise(r => {
          req.onreadystatechange = () => {
            if (req.readyState !== 4) return;
            if (req.responseText.length === 0) return;
            try { r(JSON.parse(req.responseText)); } catch(err) { r(null); }
          };
        });
      };
      
      await new Promise(r => window.addEventListener('load', r));
      
      let div = c => { let d = document.createElement('div'); d.classList.add(c); return d; }
      
      let body = document.body;
      
      let snackControl = body.appendChild(div('snackControl'));
      let availableDom = snackControl.appendChild(div('available'));
      let insertedDom = snackControl.appendChild(div('inserted'));
      
      let available = {};
      let updateAvailable = upd => {
        /*
        upd ~= {
          sweetChilliHeat: {
            name: 'Sweet Chilli Heat',
            price: 4.5,
            imageUrl: '/assets/img/sch.png'
          }
        }
        */
        
        while (availableDom.firstChild) availableDom.removeChild(availableDom.firstChild);
        available = upd;
        for (let [ snackId, snackData ] of Object.entries(available)) {
          console.log(snackId, snackData);
          let snackDom = availableDom.appendChild(div('snack'));
          snackDom.classList.add(snackId);
          let snackTextDom = snackDom.appendChild(div('text'));
          snackTextDom.innerText = snackData.name;
          
          snackDom.addEventListener('mousedown', async () => {
            await poll(`addInserted?${snackId}`); // Do the add
            await update();                     // See server confirmation
          });
        }
      };
      
      let insId = 0;
      let inserted = [];
      let updateInserted = ({ add=[], rem=[] }) => {
        
        for (let snackId of add) {
          // Create data
          let insertData = { snackId, id: insId++ };
          inserted.push(insertData);
          
          // Create dom
          let snackData = available[snackId];
          let snackDom = insertedDom.appendChild(div('snack'));
          snackDom.classList.add(snackId);
          let snackTextDom = snackDom.appendChild(div('text'));
          snackTextDom.innerText = snackData.name;
          
          snackDom.snackData = snackData;
          //snackDom.style.backgroundImage = `url("${snackData.imageUrl}")`;
          snackDom.addEventListener('mousedown', async () => {
            await poll(`remInserted?${snackId}`); // Do the removal
            await update();                     // See that server confirmed
            //updateInserted({ rem: [ snackId ] });
          });
          
          insertData.snackDom = snackDom;
        }
        
        for (let snackId of rem) {
          let ind = inserted.findIndex(snackData => snackData.snackId === snackId);
          if (ind === -1) continue;
          let snackData = inserted[ind];
          
          // Remove data
          inserted.splice(ind, 1);
          
          // Remove dom
          insertedDom.removeChild(snackData.snackDom);
        }
        
      };
      
      let update = async () => {
        inserted.forEach(ins => { ins.snackDom.parentNode.removeChild(ins.snackDom); });
        inserted = [];
        
        let data = await poll('updateData')
        updateAvailable(data.available);
        updateInserted(data.inserted);
        return data;
      }
      
      let loading = snackControl.appendChild(div('loading'));
      loading.innerText = 'Loading...';
      
      await update();
      snackControl.removeChild(loading);
      setInterval(update, 10000);
      
      
      
    })();</script>
  </head>
  <body>
  </body>
</html>
